<!DOCTYPE html>
<html>
<head>
    <title id="title"></title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/leaflet.css">
    <script src="js/jquery-1.10.2.min.js"></script>
    <script type="text/javascript" src="data/info.js"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            // Update info
            $('#title').html(title);
            $('#infobox').html(info);
            })
    </script>
</head>
<body>
    <div id="map"></div>
    <script src="js/leaflet.js"></script>
    <script src="js/topojson.js"></script>
    <script>
        $(document).ready(function () {
            var map = L.map('map');

            var osmLayer = L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png", {
                attribution: "&copy; <a href='http://osm.org/copyright'>OpenStreetMap contributors</a>",
                });
            map.addLayer(osmLayer);

            var popup = L.popup();

            function onMapClick(e) {
                var x = e.latlng["lng"];
                var y = e.latlng["lat"];
                var left = x - 0.0005;
                var right = x + 0.0005;
                var top = y + 0.0005;
                var bottom = y - 0.0005;
                var josmUrl = "http://localhost:8111/";
                josmUrl += "load_and_zoom?left=" + left + "&right=" + right + "&top=" + top + "&bottom=" + bottom;
                var josmLink = "Modifica in <a href='" + josmUrl + "' target='_blank' title=\"Modifica in JOSM\">JOSM</a>";
                popup
                    .setLatLng(e.latlng)
                    .setContent(josmLink)
                    .openOn(map);
            }

            map.on('click', onMapClick);

            var overlayMaps = {};
            var layers = [];

            $.getJSON("data/zones_info.json", function(data) {
                zones = data.zones;
                for (var i in zones) {
                    var name = zones[i].name;
                    var bbox = zones[i].bbox;
                    var latLon = zones[i].center;
                    var output = zones[i].output;

                    if (i == 0) {
                        map.setView(latLon, mapZoom);
                    }

                    if (output == "vector") {
                        layers.push({
                            "notinosm": L.geoJson(null, {
                                                    style: {
                                                    weight: 5,
                                                    color: 'red',
                                                    opacity: 1}
                                                    }),
                            "onlyinosm": L.geoJson(null, {
                                                    style: {
                                                    weight: 5,
                                                    color: 'green',
                                                    opacity: 1}
                                                    })
                        });
                    } else if (output == "raster") {
                            var stringa = 'data/' + name + '/tiles/' + 'notinosm';
                        layers.push({
                            "notinosm": L.tileLayer('data/' + name + '/tiles/' + 'notinosm/{z}/{x}/{y}.png'),
                            "onlyinosm": L.tileLayer('data/' + name + '/tiles/' + 'onlyinosm/{z}/{x}/{y}.png')
                        });
                    };

                    if (output == "vector") {
                        (function (i) {
                            var name = zones[i].name;
                            $.getJSON('data/' + name + '/topojson/vector.GeoJSON', function (data) {
                                layers[i]["notinosm"].addData(topojson.feature(data,
                                           data["objects"]["notinosm"]));
                                layers[i]["onlyinosm"].addData(topojson.feature(data,
                                          data["objects"]["onlyinosm"]));
                            });
                        })(i);
                    }

                    map
                        .addLayer(layers[i]["notinosm"])
                        .addLayer(layers[i]["onlyinosm"]);

                    // Deactivate layers
                    map.removeLayer(layers[i]["onlyinosm"]);
                    if (i > 0) {
                        map.removeLayer(layers[i]["notinosm"]);
                    }

                    overlayMaps[name + ": mancanti in OSM"] = layers[i]["notinosm"];
                    overlayMaps[name + ": presenti solo in OSM"] = layers[i]["onlyinosm"];
                }
                var baseMaps = {"OpenStreetMap": osmLayer};
                L.control.layers(baseMaps, overlayMaps, {"collapsed": false}).addTo(map);
            });
        })
    </script>
    <div id="infobox">
    </div>
</body>
</html>
