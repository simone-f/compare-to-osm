# compare-to-osm

This program compares the geometries of highways in OSM with those in one or more shapefiles.

It generates GeoJSON files and Shapefiles with highways missing in OSM and in the open data and shows the results on a Leaflet map, as Topojson files or PNG tiles.

[Here](https://dl.dropboxusercontent.com/u/41550819/OSM/compare-to-osm/index.html) is an ouput example with open data from Italy.

## Dependencies
Programs:

* wget
* osmconvert
* ogr2ogr
* topojson
* mapnik
* jinja2

In Ubuntu, install everything with:

        sudo apt-get install osmctools gdal-bin nodejs python-mapnik python-jinja2
        sudo npm install -g topojson

You will also need Spatialite or PostGIS, depending on the comparator you use (see section below):

        sudo apt-get install spatialite-bin

or

        sudo apt-get install postgis postgresql-contrib osmosis

Data:

* a WGS84 shapefile with open data regarding highways from the the zone of your interest, e.g. a local council
* a Shapefile with the boundaries of the zone (if using `highwaysgeometryspatialite` comparator).

## Usage
### Configuration
Create a new project directory and add a `project.json` file with the configuration.<br>For more informations, see `projects/README.md` and `projects/projectdemo` as an example.

### Execution
Show the list of options:

        python ./compare-to-osm.py -h

Analyse the data and create the output files:

        python ./compare-to-osm.py projects/myproject/project.json --analyse

Read analysis' output files, create map data (GeoJSON or PNG tiles) and the web page:

        python ./compare-to-osm.py projects/myproject/project.json --create_web_page

Open `projects/myproject/html/index.html` in a web browser to see the results.

### Demo
* Download OSM data, compare it with the open data and create the web page by running:

       `python ./compare-to-osm.py projects/projectdemo/project.json --donwload_osm --analyse --create_web_page`

* See the result by opening `projects/projectdemo/html/index.html` in a web browser.

## Notes

### Comparators
The comparison is performed by one of the modules in `comparators` directory:

* `comparators/highwaysgeometryspatialite.py` needs spatialite-bin package and supports Linestring or Multilinestring shapefiles.
* `comparators/highwaysgeometrypostgis.py` needs PostGIS and osmosis and supports Multilinestring shapefiles.

You may write new modules to compare different OSM object (e.g. rivers). Add a module in `comparators/` and write its name in the project file (e.g. `"comparator": "riversgeometryspatialite"`).

### OpenStreetMap data
When using `--analyze` the program compares the open data of a task (zone) with an existing OSM file. You can create this file in two ways:

* for small areas, write an Overpass query in the project file and then use `--download_osm` to automatically download the data through the program (see `projects/projectdemo/project.json` as an example)
* for big areas, you may prefer to filter the data from a local OSM file. Move this file to `project_name/data/osm_data/task_name/`, write the osmfilter command in `project.json` and use the option `--filter_osm`.<br>E.g. If `Verona` is a task name in the project file:

       cd projects/myproject/data/osm_data/Verona
       
       osmconvert Italy.pbf -B=Verona.poly -o=Verona_full.o5m

: and add in the task properties, in `project.json`:

       "osm_data": {"osmfilter_command": "osmfilter --keep=  --keep=highway Verona_full.o5m -o=Verona.o5m"}

### Creating a custom web page
The web page is based on the Jinja2 template `html/templates/index.html`. A custom web page can be generated by adding a custom template `index.html` in `project_directory/templates` directory.

## Development
License: GPL v3

Author: Simone F.

Coding conventions: flake8
